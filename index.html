<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Career kaptain Dashboard</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 40px 20px;
      color: #fff;
      background: url('https://cdn.prod.website-files.com/6009ec8cda7f305645c9d91b/6010828d33e669bfe53402f9_6002086f72b727fe2401d779_2018-illustration-trends.png') no-repeat center center fixed;
      background-size: cover;
    }
  
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.65);
      z-index: -1;
    }
  
    h1 {
      text-align: center;
      font-size: 36px;
      margin-bottom: 20px;
    }
  
    /* 🌟 Landing Selector */
    #initialSelector {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 80vh;
      gap: 30px;
      flex-wrap: wrap;
      transition: opacity 0.5s ease;
    }
  
    .landing-button {
      padding: 20px 40px;
      font-size: 22px;
      font-weight: bold;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
      transition: background-color 0.3s, transform 0.2s;
    }
  
    .landing-button:hover {
      transform: scale(1.05);
    }
  
    .college-btn {
      background-color: #4CAF50;
      color: white;
    }
  
    .course-btn {
      background-color: #2196F3;
      color: white;
    }
  
    /* 🏫 Dashboard Content */
    #dashboardContent, #courseSearchContent {
      display: none;
      animation: fadeIn 0.8s ease forwards;
    }
  
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.5);
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
  
    .controls select, .controls input, .controls button {
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: 'Poppins', sans-serif;
    }
  
    .college-card, .comparison-box {
      background: rgba(255, 255, 255, 0.88);
      border-radius: 16px;
      padding: 16px;
      color: #000;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
  
    .college-card button, .controls button, .comparison-box button {
      background: #ff9800;
      color: white;
      font-weight: bold;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
    }
  
    .comparison-box h4.college-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 12px;
    }
  
    .no-college-message {
      text-align: center;
      font-weight: bold;
      padding: 20px;
      color: #ff4444;
      grid-column: 1 / -1;
    }
  
    .section-header {
      font-weight: bold;
      background: rgba(0, 0, 0, 0.05);
      padding: 8px 12px;
      border-radius: 8px;
      margin-top: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      color: #333;
    }
  
    .section-card {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 8px;
      font-size: 14px;
      color: #000;
    }
  
    .comparison-box select {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      padding: 8px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: 'Poppins', sans-serif;
      background-color: #fff;
      color: #000;
      margin-top: 5px;
    }
  
    /* 📋 Modal Styling */
    #interestModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.75);
      z-index: 999;
      justify-content: center;
      align-items: center;
    }
  
    #interestModal > div {
      background: #fff;
      padding: 25px 20px;
      border-radius: 12px;
      width: 400px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      color: #000;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
  
    #interestModal h2 {
      margin: 0 0 20px;
      font-size: 24px;
      font-weight: 600;
      text-align: center;
      color: #333;
    }
  
    #interestForm label {
      font-weight: bold;
      display: block;
      margin: 10px 0 5px;
    }
  
    #interestForm input, #interestForm select {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: 'Poppins', sans-serif;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
  
    #interestForm button {
      margin-top: 10px;
      margin-right: 10px;
      background: #ff9800;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
    }
  
    #interestForm button[type="button"] {
      background: #ccc;
      color: #000;
    }
  
    .landing-button:hover {
      background-color: #ff9800;
    }
  
    .or-text {
      font-weight: bold;
      color: #fff;
      margin: 0 10px;
    }
  
    .btech-filter-label {
      color: #fff;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: 10px;
    }
  
    #collegeCourseContainer .college-course-group select {
      flex: 1 1 48%;
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: 'Poppins', sans-serif;
      margin-bottom: 10px;
    }
  
    .action-button {
      background: #ff9800;
      color: white;
      font-weight: bold;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      transition: background-color 0.3s;
    }
  
    .action-button:hover {
      background-color: #e68900;
    }
  
    /* 🎯 Horizontal Scroll for College Cards */
    .college-scroll-wrapper {
      overflow-x: auto;
      overflow-y: hidden;
      width: 100%;
      padding: 10px 0;
    }
  
    .college-scroll-list {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      gap: 16px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      padding: 10px;
    }
  
    .college-card {
      flex: 0 0 300px;
      scroll-snap-align: start;
      background: rgba(255, 255, 255, 0.88);
      border-radius: 16px;
      padding: 16px;
      color: #000;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    .comparison-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  justify-content: center;
  padding: 10px 0;
  max-width: 100%;
}
@media (min-width: 1200px) {
  .comparison-section {
    grid-template-columns: repeat(4, 1fr);
  }
}

.controls-toggle-button {
  background: #ff9800;
  color: white;
  font-weight: bold;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-family: 'Poppins', sans-serif;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  font-size: 14px;
  transition: background-color 0.3s;
}

.controls-toggle-button:hover {
  background-color: #e68900;
}

.priority-indicator-badge {
  background-color: red;
  color: white;
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 0.75em;
  font-weight: bold;
  margin-left: 8px;
  display: inline-flex;
  align-items: center;
  vertical-align: middle;
}

.blinking-star {
  margin-right: 5px;
  color: yellow;
  font-size: 1.1em;
  animation: blink-animation 1.5s infinite ease-in-out;
}

.priority-text-badge {
  /* Optional: specific styles for the text "Priority" */
}

@keyframes blink-animation {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.4;
    transform: scale(0.85);
  }
}

/* 💰 Fees Slider Styles */
.fees-slider-container {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 10px;
  background: rgba(255, 255, 255, 0.95);
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  width: 500px;
  font-family: 'Poppins', sans-serif;
  position: relative;
  height: 45px;
  box-sizing: border-box;
}

.fees-slider-container.disabled {
  opacity: 0.6;
  pointer-events: none;
}

.fees-label {
  font-size: 11px;
  font-weight: 600;
  color: #333;
  margin: 0;
  white-space: nowrap;
  flex-shrink: 0;
}

.fees-range-slider {
  flex: 1;
  min-width: 100px;
  height: 4px;
  border-radius: 3px;
  background: linear-gradient(to right, #4CAF50 0%, #FF9800 50%, #F44336 100%);
  outline: none;
  opacity: 0.8;
  transition: opacity 0.2s;
  position: relative;
}

.fees-range-slider:hover {
  opacity: 1;
}

.fees-range-slider::-webkit-slider-thumb {
  appearance: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #ff9800;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.fees-range-slider::-moz-range-thumb {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #ff9800;
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.fees-input-group {
  display: flex;
  align-items: center;
  gap: 2px;
  flex-shrink: 0;
}

.fees-currency {
  font-size: 20px;
  color: #666;
  margin: 0;
}

.fees-manual-input {
  width: 100px;
  height: 30px;
  padding: 1px 6px;
  font-size: 10px;
  border: 1px solid #ccc;
  border-radius: 3px;
  text-align: center;
  font-family: 'Poppins', sans-serif;
  flex-shrink: 0;
  box-sizing: border-box;
}

.fees-value-display {
  font-size: 20px;
  font-weight: 600;
  color: #ff9800;
  white-space: nowrap;
  flex-shrink: 0;
  width: 60px;
  text-align: center;
  overflow: hidden;
}

/* 🔄 Loading Spinner Styles */
.loading-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 5px solid rgba(255, 255, 255, 0.3);
  border-top: 5px solid #ff9800;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.loading-text {
  color: white;
  font-size: 18px;
  font-weight: 600;
  margin-top: 20px;
  font-family: 'Poppins', sans-serif;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-container.hidden {
  display: none;
}

/* ❌ Close Button Styles for Comparison Cards */
.comparison-close-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 24px;
  height: 24px;
  background: #ff4444;
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: background-color 0.2s, transform 0.1s;
  z-index: 10;
}

.comparison-close-btn:hover {
  background: #ff0000;
  transform: scale(1.1);
}

.comparison-box {
  position: relative; /* Ensure close button positions correctly */
}

/* 🏢 Companies Section Styles */
.companies-section {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 8px;
  padding: 12px;
  margin-top: 10px;
  border: 1px solid #e0e0e0;
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.companies-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 8px;
}

.company-tag {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: transform 0.2s ease;
}

.company-tag:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.no-companies-message {
  font-style: italic;
  color: #666;
  text-align: center;
  padding: 10px;
}

  </style>
  
</head>

<body>
  <div class="overlay"></div>
  
  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="loading-container">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading College Data...</div>
  </div>

  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
    <button id="modeToggleBtn" class="controls-toggle-button">Switch to Course Search</button>
    <h1 style="flex-grow: 1; text-align: center; font-size: 40px; color: white; margin: 0;">DASHBOARD VIEWER</h1>
    <div style="width: 160px;"></div> <!-- Empty space matching button width -->
  </div>
  
  </div>
  

  </div>
  
  <!-- Landing Selector -->
  <div id="initialSelector">
    <button class="landing-button college-btn" onclick="selectMode('college')">Search by College</button>
    <button class="landing-button course-btn" onclick="selectMode('course')">Search by Course</button>
  </div>

  <!-- Dashboard and Course Search Content areas are hidden initially -->
 <!-- 🎯 Dashboard Content (for College Search) -->
<div id="dashboardContent" style="display:none;">
  <div class="controls" id="collegeControls">
    <select id="stateSelect">
      <option value="">Select State</option>
    </select>

    <select id="categorySelect" disabled>
      <option value="">Select Category</option>
    </select>

    <input type="text" id="searchBox" list="collegeSuggestions" placeholder="Search Colleges" />
    <datalist id="collegeSuggestions">
    </datalist>

      <div id="feesFilter" class="fees-slider-container">
      <label class="fees-label">Max Fees:</label>
      <input type="range" id="feesSlider" class="fees-range-slider" 
             min="0" max="2000000" value="2000000" step="50000">
      <div class="fees-input-group">
        <span class="fees-currency">₹</span>
        <input type="number" id="feesInput" class="fees-manual-input" 
               min="0" max="2000000" value="2000000" step="50000">
      </div>
      <span class="fees-value-display" id="feesDisplay">₹20L</span>
    </div>

    <label class="btech-filter-label">
      <input type="checkbox" id="btechOnly" /> B.Tech Only
    </label>

    <button id="resetBtn">Reset</button>
  </div>

  <div id="promptMessage" style="display:none;">Please select a category to enable fee filter</div>
  <div class="college-scroll-wrapper">
    <div id="collegeList" class="college-scroll-list"></div>
  </div>   
  <div id="comparisonSection" class="comparison-section"></div>
</div>

<!-- 🎯 Course Search Content -->
<div id="courseSearchContent" style="display:none;">
  <div class="controls" id="courseControls">
<label for="courseInput">Select Course:</label>
<input type="text" id="courseInput" list="courseSuggestions" placeholder="Type or select a course...">
<datalist id="courseSuggestions">
</datalist>

    <div id="specializationContainer" style="display:none; border: 1px solid #ccc; padding: 10px; border-radius: 8px; max-height: 150px; overflow-y: auto; background: rgba(255,255,255,0.9); color: #333;">
      <p style="margin:0; font-size: 0.9em;">Select Specialization(s):</p>
      <div id="specializationCheckboxes">
        </div>
  </div>

    <select id="stateDropdown" disabled>
      <option value="">Select State</option>
    </select>

    <div id="feesDropdown" class="fees-slider-container">
      <label class="fees-label">Max Fees:</label>
      <input type="range" id="feesSliderCourse" class="fees-range-slider" 
             min="0" max="2000000" value="2000000" step="50000">
      <div class="fees-input-group">
        <span class="fees-currency">₹</span>
        <input type="number" id="feesInputCourse" class="fees-manual-input" 
               min="0" max="2000000" value="2000000" step="50000">
      </div>
      <span class="fees-value-display" id="feesDisplayCourse">₹20L</span>
    </div>

    <button id="courseResetBtn">Reset Filters</button>
  </div>

  <div class="college-scroll-wrapper">
    <div id="courseCollegeList" class="college-scroll-list"></div>
  </div>
  
  <div id="courseComparisonSection" class="comparison-section"></div>
</div>


  <!-- Modal (Lead Submission) -->
  <div id="interestModal">
    <div>
      <h2>Lead Submission Form</h2>
      <form id="interestForm">
        <label><strong>Select Colleges & Courses:</strong></label>
        <div id="collegeCourseContainer"></div>

        <button type="button" id="addMoreBtn" style="background: #2196f3;">+ Add Another College & Course</button>

        <label>Student Name:</label>
        <input type="text" id="studentName" required />

        <label>Student Phone Number:</label>
        <input type="tel" id="studentPhone" required />

        <label>Student Email Address:</label>
        <input type="email" id="studentEmail" required />

        <label>Name of Counselor Pushing the Lead:</label>
        <select id="counselorSelect" required>
          <option value="">Select Counselor</option>
          <option value="Amit">Amit</option>
          <option value="Sonia">Sonia</option>
          <option value="Rahul">Rahul</option>
        </select>

        <button type="submit">Submit</button>
        <button type="button" onclick="closeModal()">Cancel</button>
      </form>
    </div>
  </div>
  
  <!-- Datalist for Modal College Autocomplete -->
  <datalist id="modalCollegeSuggestions">
  </datalist>
  
  <script>
    // 🌟 GLOBAL VARIABLES
    let selectedColleges = [];
    let selectedCourseColleges = [];
    
        // 🗄️ Data Arrays
    const collegesData = [];      
    const coursesData = [];       
    const categoriesData = [];    
    const placementsData = [];    
    
    // 📡 Simple Data Loading Function
    async function loadAllData() {
      console.log('🚀 Loading data from JSON files...');
      
      try {
        // Show loading spinner
        document.getElementById('loadingSpinner').style.display = 'flex';
        
        // Load all JSON files
        const [colleges, courses, categories, placements] = await Promise.all([
          fetch('./Data/colleges.json').then(r => r.json()),
          fetch('./Data/courses.json').then(r => r.json()),
          fetch('./Data/categories.json').then(r => r.json()),
          fetch('./Data/placements.json').then(r => r.json())
        ]);
        
        // Populate arrays
        collegesData.push(...colleges);
        coursesData.push(...courses);
        categoriesData.push(...categories);
        placementsData.push(...placements);
        
        console.log('✅ Data loaded successfully!');
        console.log(`Colleges: ${collegesData.length}, Courses: ${coursesData.length}`);
        
        // Hide loading spinner and initialize app
        document.getElementById('loadingSpinner').style.display = 'none';
        populateStates();
        populateCourses();
        populateCourseStates();
        populateCollegeSuggestions();
        populateModalCollegeSuggestions();
        setupSmartCollegeSearch();
        
      } catch (error) {
        console.error('❌ Error loading data:', error);
        document.getElementById('loadingSpinner').style.display = 'none';
        alert('⚠️ To load external JSON files, please run a local server:\n\n1. Open Command Prompt in your project folder\n2. Run: python -m http.server 8000\n3. Open: http://localhost:8000');
      }
    }
    
    // 🌟 DOM SELECTORS
    const stateSelect = document.getElementById('stateSelect');
    const categorySelect = document.getElementById('categorySelect');
    const resetBtn = document.getElementById('resetBtn');
    const searchBox = document.getElementById('searchBox');
    const collegeList = document.getElementById('collegeList');
    const comparisonSection = document.getElementById('comparisonSection');
    const promptMessage = document.getElementById('promptMessage');
    const btechOnlyCheckbox = document.getElementById('btechOnly');
    const feesSlider = document.getElementById('feesSlider');
    const feesInput = document.getElementById('feesInput');
    const feesDisplay = document.getElementById('feesDisplay');
    const courseInput = document.getElementById('courseInput');
    const courseDataList = document.getElementById('courseSuggestions');
    const specializationDropdown = document.getElementById('specializationDropdown');
    const stateDropdown = document.getElementById('stateDropdown');
    const feesDropdown = document.getElementById('feesDropdown');
    const feesSliderCourse = document.getElementById('feesSliderCourse');
    const feesInputCourse = document.getElementById('feesInputCourse');
    const feesDisplayCourse = document.getElementById('feesDisplayCourse');
    const courseCollegeList = document.getElementById('courseCollegeList');
    const courseComparisonSection = document.getElementById('courseComparisonSection');

    // 🧠 HELPER FUNCTIONS
const formatINR = (value) => isNaN(value) ? value : Number(value).toLocaleString('en-IN');

// 🚀 DEBOUNCE UTILITY for Performance Optimization
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// 🚀 DEBOUNCED UPDATE FUNCTIONS for Smooth Performance
const debouncedUpdateCollegeList = debounce(updateCollegeList, 150);
const debouncedUpdateCourseCollegeList = debounce(updateCourseCollegeList, 150);

function isBtechCourse(course) {
  return course.course_name.toLowerCase().includes("b.tech");
}

// 💰 FEES SLIDER HELPER FUNCTIONS
// Define checkpoint values for fees slider (every 50K)
const feesCheckpoints = [0, 50000, 100000, 150000, 200000, 250000, 300000, 350000, 400000, 450000, 500000, 550000, 600000, 650000, 700000, 750000, 800000, 850000, 900000, 950000, 1000000, 1050000, 1100000, 1150000, 1200000, 1250000, 1300000, 1350000, 1400000, 1450000, 1500000, 1550000, 1600000, 1650000, 1700000, 1750000, 1800000, 1850000, 1900000, 1950000, 2000000];

function findNearestCheckpoint(value) {
  return feesCheckpoints.reduce((prev, curr) => 
    Math.abs(curr - value) < Math.abs(prev - value) ? curr : prev
  );
}

function formatFeesDisplay(value) {
  if (value === 0) return '₹0 (Free)';
  if (value >= 10000000) return `₹${(value / 10000000).toFixed(1)}Cr`;
  if (value >= 100000) return `₹${(value / 100000).toFixed(1)}L`;
  if (value >= 1000) return `₹${(value / 1000).toFixed(0)}K`;
  return `₹${value}`;
}

function syncSliderAndInput(sliderElement, inputElement, displayElement) {
  const rawValue = parseInt(sliderElement.value);
  const snappedValue = findNearestCheckpoint(rawValue);
  
  sliderElement.value = snappedValue;
  inputElement.value = snappedValue;
  displayElement.textContent = formatFeesDisplay(snappedValue);
}

function syncInputAndSlider(inputElement, sliderElement, displayElement) {
  let value = parseInt(inputElement.value);
  const min = parseInt(inputElement.min);
  const max = parseInt(inputElement.max);
  
  // Handle invalid input
  if (isNaN(value)) {
    value = min; // Default to minimum if invalid
  }
  
  // Clamp value within bounds
  if (value < min) value = min;
  if (value > max) value = max;
  
  // Snap to nearest checkpoint
  const snappedValue = findNearestCheckpoint(value);
  
  inputElement.value = snappedValue;
  sliderElement.value = snappedValue;
  displayElement.textContent = formatFeesDisplay(snappedValue);
}

// 📋 POPULATION FUNCTIONS
function populateStates() {
  const states = [...new Set(collegesData.map(c => c.state))].sort();
  states.forEach(state => {
    const opt = document.createElement("option");
    opt.value = state;
    opt.textContent = state;
    stateSelect.appendChild(opt);
  });
}

function populateCourses() {
    // const courseDataList = document.getElementById('courseSuggestions'); // Moved selector outside if used elsewhere
    if (!courseDataList) return;

    courseDataList.innerHTML = ''; // Clear previous suggestions

    const uniqueCourses = [...new Set(coursesData.map(course => course.course_name))].sort(); // Still sorted

    uniqueCourses.forEach(courseName => {
        const option = document.createElement('option');
        option.value = courseName; // Datalist options use the value attribute for matching
        // You can also set option.textContent = courseName; if you want, but value is key for datalist
        courseDataList.appendChild(option);
    });
}

function populateCollegeSuggestions() {
    const collegeDataList = document.getElementById('collegeSuggestions');
    if (!collegeDataList) return;

    collegeDataList.innerHTML = ''; // Clear previous suggestions

    const uniqueColleges = [...new Set(collegesData.map(college => college.college_name))].sort();

    uniqueColleges.forEach(collegeName => {
        const option = document.createElement('option');
        option.value = collegeName;
        collegeDataList.appendChild(option);
    });
}

function setupSmartCollegeSearch() {
    const searchBox = document.getElementById('searchBox');
    const collegeDataList = document.getElementById('collegeSuggestions');
    
    if (!searchBox || !collegeDataList) return;
    
    // 🚀 Debounced autocomplete update for smooth typing
    const debouncedAutocompleteUpdate = debounce(function(query) {
        collegeDataList.innerHTML = '';
        
        if (query.length < 2) {
            // Show all colleges if query is too short
            populateCollegeSuggestions();
            return;
        }
        
        // Filter colleges that match the query (name or state)
        const matches = collegesData.filter(college => 
            college.college_name.toLowerCase().includes(query) ||
            college.state.toLowerCase().includes(query)
        ).slice(0, 10); // Limit to 10 suggestions for performance
        
        matches.forEach(college => {
            const option = document.createElement('option');
            option.value = college.college_name;
            option.textContent = `${college.college_name} (${college.state})`;
            collegeDataList.appendChild(option);
        });
    }, 100);
    
    searchBox.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        debouncedAutocompleteUpdate(query);
    });
}

function populateModalCollegeSuggestions() {
    const modalCollegeDataList = document.getElementById('modalCollegeSuggestions');
    if (!modalCollegeDataList) return;

    modalCollegeDataList.innerHTML = ''; // Clear previous suggestions

    const uniqueColleges = [...new Set(collegesData.map(college => college.college_name))].sort();

    uniqueColleges.forEach(collegeName => {
        const option = document.createElement('option');
        option.value = collegeName;
        modalCollegeDataList.appendChild(option);
    });
}

function populateCategories() {
  categorySelect.innerHTML = '<option value="">Select Category</option>';
  ["Engineering", "Management", "Medical", "Others"].forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    categorySelect.appendChild(opt);
  });
}

function populateCourseStates() {
  const states = [...new Set(collegesData.map(c => c.state))].sort();
  states.forEach(state => {
    const opt = document.createElement('option');
    opt.value = state;
    opt.textContent = state;
    stateDropdown.appendChild(opt);
  });
}
// 🎯 UPDATE FUNCTIONS (Search / Filter Functions)
function updateCollegeList() {
  const state = stateSelect.value;
  const category = categorySelect.value;
  const maxFees = parseInt(feesSlider ? feesSlider.value : 2000000);
  const query = searchBox.value.toLowerCase();
  const btechOnly = btechOnlyCheckbox.checked;

  selectedColleges = [];
  comparisonSection.innerHTML = "";

  let resultColleges = [];

  if (!state && !category) {
    resultColleges = collegesData.filter(col =>
      col.college_name.toLowerCase().includes(query)
    );
  } else {
    resultColleges = collegesData.filter(col => {
      const belongsToState = !state || col.state === state;
      const isInCategory = !category || categoriesData.some(cat =>
        cat.college_id === col.college_id && cat.category === category
      );
      const matchesSearch = col.college_name.toLowerCase().includes(query);
      const hasCourses = coursesData.some(course =>
        course.college_id === col.college_id &&
        course.category === category &&
        (!btechOnly || isBtechCourse(course))
      );
      const matchesFees = !category || coursesData.some(course =>
        course.college_id === col.college_id &&
        course.category === category &&
        (!btechOnly || isBtechCourse(course)) &&
        course.fees_per_year <= maxFees
      );

      return belongsToState && isInCategory && matchesSearch && hasCourses && matchesFees;
    });
  }

  renderCollegeCards(resultColleges, category);
}

function updateCourseCollegeList() {
    const selectedCourse = courseInput.value;
    // const selectedSpec = specializationDropdown.value; // Remove this line

    // --- NEW: Get selected specializations from checkboxes ---
    const specCheckboxes = document.querySelectorAll('#specializationCheckboxes input[type="checkbox"]:checked');
    const selectedSpecs = Array.from(specCheckboxes).map(cb => cb.value); // This is now an ARRAY of strings
    // --- End NEW ---

    const selectedState = stateDropdown.value;
    const maxFees = parseInt(feesSliderCourse ? feesSliderCourse.value : 2000000);

    console.log("[updateCourseCollegeList] Selected Course:", selectedCourse, "Selected Specs:", selectedSpecs); // Optional log

    if (!selectedCourse) {
        // ... (your existing logic to clear lists if no course is selected) ...
        courseCollegeList.innerHTML = '';
        courseComparisonSection.innerHTML = '';
        selectedCourseColleges = [];
        renderCourseCollegeCards([], "", []); // Pass empty array for specs
        return;
    }

    // --- ADJUSTED: Filter coursesData ---
    let courseFilteredCourses = coursesData.filter(c => {
        const courseMatch = c.course_name === selectedCourse;
        if (!courseMatch) return false; // Must match course name

        // If NO specialization checkboxes are checked, include the course
        // (Show all specializations for the selected course)
        if (selectedSpecs.length === 0) return true;

        // If checkboxes ARE checked, check if the course's specialization is in the selected list
        return selectedSpecs.includes(c.specialisation);
    });
    // --- End ADJUSTED ---

    const collegeIds = [...new Set(courseFilteredCourses.map(c => c.college_id))];
    let filteredColleges = collegesData.filter(c => collegeIds.includes(c.college_id));

    if (selectedState) {
        filteredColleges = filteredColleges.filter(c => c.state === selectedState);
    }

    // --- ADJUSTED: Fee filter logic ---
    filteredColleges = filteredColleges.filter(c => {
        // Check if *any* course in this college matches the criteria
        return coursesData.some(course =>
            course.college_id === c.college_id &&
            course.course_name === selectedCourse &&
            // Check against selected specializations (or ignore if none selected)
            (selectedSpecs.length === 0 || selectedSpecs.includes(course.specialisation)) &&
            // Check fees - must be within max fees limit
            course.fees_per_year <= maxFees
        );
    });
    // --- End ADJUSTED ---

    // Pass the array of selectedSpecs to the rendering function
    renderCourseCollegeCards(filteredColleges, selectedCourse, selectedSpecs);
}

// 🖼️ RENDER FUNCTIONS (Cards Display)
function renderCollegeCards(colleges, category) {
    const collegeList = document.getElementById("collegeList");
    if (!collegeList) {
        console.error("Element with ID 'collegeList' not found.");
        return;
    }
    collegeList.innerHTML = ""; // Clear previous cards

    if (!colleges || colleges.length === 0) {
        const msg = document.createElement("div");
        msg.className = "no-college-message";
        msg.textContent = "❌ No college fulfills the criteria.";
        collegeList.appendChild(msg);
        return;
    }

    colleges.forEach(col => {
        if (!col || !col.college_id || !col.college_name) {
            console.warn("Skipping invalid college object in renderCollegeCards:", col);
            return; // Skip this iteration if essential college data is missing
        }

        const card = document.createElement("div");
        card.className = "college-card";

        // Find a default course for the "Mark Interested" button, if a category is provided
        const defaultCourse = (category && coursesData) ? coursesData.find(c => c.college_id === col.college_id && c.category === category) : null;

        card.innerHTML = `
            <strong>
                ${col.college_name}
                ${col.isPriority ? `
                  <span class="priority-indicator-badge">
                    <span class="blinking-star">&#x2B50;</span>
                    <span class="priority-text-badge">Priority</span>
                  </span>` : ''}
            </strong><br>
            <br>
            ${col.website ? `<a href="${col.website}" target="_blank">${col.website}</a>` : '-'}<br>
            <br>
            <div class="college-ranking-usp" style="font-size: 0.9em; margin-bottom: 10px; color: #333;">
                ${col.Ranking_or_USP || ''}
            </div>
            <div style="text-align:center; margin-top: 10px;">
                <button onclick="openInterestModal('${col.college_name}', '${defaultCourse ? defaultCourse.course_name || '' : ''}')">Mark Interested</button>
                <button onclick="selectCollege('${col.college_id}', '${category || ''}')">Compare</button>
            </div>
        `;
        collegeList.appendChild(card);
    });
};
/**
 * Renders college cards for the Course Search results.
 * @param {Array} colleges - Array of college objects to display.
 * @param {string} selectedCourse - The name of the course selected in the main dropdown.
 * @param {Array} selectedSpecs - An array of specialization names selected via checkboxes. Can be empty.
 */
 function renderCourseCollegeCards(colleges, selectedCourse, selectedSpecs) {
    // Get the container div for the course college list
    const courseCollegeList = document.getElementById('courseCollegeList');
    if (!courseCollegeList) {
        console.error("Element with ID 'courseCollegeList' not found.");
        return;
    }
    courseCollegeList.innerHTML = ''; // Clear previous cards

    // Handle case where no colleges match the filters
    if (!colleges || colleges.length === 0) {
        const msg = document.createElement("div");
        msg.className = "no-college-message";
        msg.textContent = "❌ No colleges match the criteria.";
        courseCollegeList.appendChild(msg);
        return;
    }

    // Loop through each college that passed the filters
    colleges.forEach(col => {
        // Basic check if college object is valid
        if (!col || !col.college_id || !col.college_name) {
             console.warn("Skipping invalid college object:", col);
             return; // Skip this iteration
        }

        const div = document.createElement("div");
        div.className = "college-card"; // Use the same card style

        let courseForCompareButton = null; // Variable to hold a representative course object for the compare button

        // Determine if specific specializations were selected
        const hasSelectedSpecs = selectedSpecs && selectedSpecs.length > 0;

        if (hasSelectedSpecs) {
            // --- Specific specializations WERE selected ---
            // Try to find a course in this college matching the selected course name
            // AND at least one of the selected specializations.
            courseForCompareButton = coursesData.find(c =>
                c.college_id === col.college_id &&
                c.course_name === selectedCourse &&
                selectedSpecs.includes(c.specialisation) // Check if course's spec is in the selected list
            );

            // Fallback: If no course matched the selected specs (e.g., data issue),
            // find *any* course matching the name in this college, just to get a course_id.
            if (!courseForCompareButton) {
                 courseForCompareButton = coursesData.find(c =>
                    c.college_id === col.college_id &&
                    c.course_name === selectedCourse
                );
            }
        } else {
            // --- NO specific specializations were selected ---
            // Find *any* course in this college matching the selected course name.
            // We need its course_id for the Compare button.
            courseForCompareButton = coursesData.find(c =>
                c.college_id === col.college_id &&
                c.course_name === selectedCourse
            );
        }

        // --- Safety Check ---
        // If, after all checks, we still couldn't find a suitable course object
        // for this college (which implies updateCourseCollegeList might have passed
        // a college that doesn't actually have the selected course in coursesData),
        // we should skip rendering this card to avoid errors.
        if (!courseForCompareButton || !courseForCompareButton.course_id) {
             console.warn(`Could not find a valid course object or course_id for ${selectedCourse} in college ${col.college_id} (${col.college_name}) during rendering.`);
             return; // Skip rendering this card
        }

        // --- Create Card HTML ---
        // Use the potentially generic selectedCourse name for display/interest modal,
        // but the specific course_id found for the compare action.
        div.innerHTML = `
         <strong>
        ${col.college_name}
        ${col.isPriority ? `
          <span class="priority-indicator-badge">
            <span class="blinking-star">&#x2B50;</span>
            <span class="priority-text-badge">Priority</span>
          </span>` : ''}
      </strong><br>
      <br>
          ${col.website ? `<a href="${col.website}" target="_blank">${col.website}</a><br>` : ''}
          <br>
          ${col.Ranking_or_USP || ''}
          <div style="text-align:center; margin-top: 10px;">
            <button onclick="openInterestModal('${col.college_name}', '${selectedCourse}')">Mark Interested</button>
            <button onclick="selectCourseCollege('${col.college_id}', '${courseForCompareButton.course_id}')">Compare</button>
          </div>`;

        // Append the newly created card to the list
        courseCollegeList.appendChild(div);
    });
}

// 📋 RENDER COURSE DETAILS FUNCTION
function renderCourseDetails(course) {
  // Check if the course object exists
  if (!course) {
      return "<p>No course details available.</p>"; // Return a message if no course data
  }

  // If the course object exists, create the HTML string with its details
  return `
    <p>
      <strong>Category:</strong> ${course.category || 'N/A'}<br>
      <strong>Course Name:</strong> ${course.course_name || 'N/A'}<br>
      <strong>Specialization:</strong> ${course.specialisation || 'N/A'}<br>
      <strong>Level:</strong> ${course.level || 'N/A'}<br>
      <strong>Duration:</strong> ${course.duration ? course.duration + ' Years' : 'N/A'}<br>
      <strong>Mode:</strong> ${course.mode || 'N/A'}<br>
      <strong>Fees/year:</strong> ₹${formatINR(course.fees_per_year) || 'N/A'}
    </p>
  `;
  // Added checks for null/undefined properties and 'N/A' as fallback
}

function updateCourseDetails(selectElement, collegeId, category) {
    const selectedCourseId = selectElement.value;
    const courseObject = coursesData.find(course =>
        course.course_id === selectedCourseId && course.college_id === collegeId
    );

    let detailsHtml = "<p>Course details not found.</p>";
    if (courseObject) {
        detailsHtml = renderCourseDetails(courseObject);
    }

    const targetDivId = `course-${collegeId}`;
    const targetDiv = document.getElementById(targetDivId);

    if (targetDiv) {
        targetDiv.innerHTML = detailsHtml;
    } else {
        console.error("Target div for course details not found:", targetDivId);
    }
}

function updateCourseDetailsForCompare(selectElement, collegeId) {
    const selectedCourseId = selectElement.value; // This is the course_id for the selected specialization

    // Find the course in your coursesData array
    const courseObject = coursesData.find(course =>
        course.course_id === selectedCourseId && course.college_id === collegeId
    );

    let detailsHtml = "<p>Specialization details not found.</p>"; // Default message
    if (courseObject) {
        detailsHtml = renderCourseDetails(courseObject); // Use the same render function
    }

    // Construct the ID of the div we need to update
    const targetDivId = `compare-course-${collegeId}`; // Note the different ID
    const targetDiv = document.getElementById(targetDivId);

    if (targetDiv) {
        targetDiv.innerHTML = detailsHtml;
    } else {
        console.error("Target div for course comparison details not found:", targetDivId);
    }
}

// 📊 COMPARISON FUNCTIONS (Compare Colleges and Courses)
function renderComparison() {
    comparisonSection.innerHTML = ""; // Clear previous comparison boxes

    selectedColleges.forEach(({ collegeId, category }) => {
        // Find the college details from collegesData
        const col = collegesData.find(c => c.college_id === collegeId);
        // Find placement data if available
        const place = placementsData.find(p => p.college_id === collegeId);

        // --- MODIFIED LOGIC TO DETERMINE filteredCourses ---
        let filteredCourses;
        if (category && category !== "") {
            // If a specific category was active when the college was added to comparison,
            // filter courses by that college AND that category.
            filteredCourses = coursesData.filter(c =>
                c.college_id === collegeId && c.category === category
            );
        } else {
            // If NO category was active (or "Select Category" was chosen in filters),
            // then get ALL courses offered by this college.
            filteredCourses = coursesData.filter(c =>
                c.college_id === collegeId
            );
        }
        // --- END OF MODIFIED LOGIC ---

        // Create a unique list of courses (name + specialization) for the dropdown
        const seen = new Set();
        const uniqueCourses = filteredCourses.filter(c => {
            const key = `${c.course_name}-${c.specialisation || 'General'}`.toLowerCase();
            if (seen.has(key)) return false;
            seen.add(key);
            return true;
        });

        // Sort unique courses, perhaps by specialization or name
        uniqueCourses.sort((a, b) => {
            const nameA = `${a.course_name} ${a.specialisation || ''}`.toLowerCase();
            const nameB = `${b.course_name} ${b.specialisation || ''}`.toLowerCase();
            if (nameA < nameB) return -1;
            if (nameA > nameB) return 1;
            return 0;
        });

        // Generate <option> elements for the course selection dropdown
        const courseOptions = uniqueCourses.map(c =>
            `<option value="${c.course_id}">${c.course_name} - ${c.specialisation || 'General'}</option>`
        ).join("");

        // Determine the default course to display initially
        // If filteredCourses has items, pick the first one, otherwise null
        const defaultCourse = filteredCourses.length > 0 ? filteredCourses[0] : null;

        // Create the comparison box element
        const box = document.createElement("div");
        box.className = "comparison-box";

        // Populate the inner HTML of the comparison box
        box.innerHTML = `
            <button class="comparison-close-btn" onclick="removeCollegeFromComparison('${collegeId}')" title="Remove from comparison">×</button>
            <h4 class="college-title">${col ? col.college_name : 'College Not Found'}</h4>

            <div class="section-header">📘 Basic Information</div>
            <div class="section-card">
                <p>
                    <strong>Established:</strong> ${col ? col.established_year || '-' : '-'}<br>
                    <br>
                    <strong>Ranking/USP:</strong> ${col.Ranking_or_USP || '-'}<br>
                    <br>
                    <strong>Website:</strong> ${col && col.website ? `<a href="${col.website}" target="_blank">${col.website}</a>` : '-'}<br>
                    <br>
                    <strong>Application Form Fees:</strong> ₹${formatINR(col ? col.application_form_fees : undefined) || 'N/A'}<br>
                    <br>
                     <strong>Coupon Link:</strong> ${col.coupon_code_link ? `<a href="${col.coupon_code_link}" target="_blank" style="color: #007bff; text-decoration: underline;">View/Apply Coupon</a>` : 'N/A'}<br>
                     <br>
                    <strong>Seat Block Fees:</strong> ₹${formatINR(col ? col.seat_block_fees : undefined) || 'N/A'}
                </p>
            </div>

            <div class="section-header">🎓 Course Details</div>
            <div class="section-card">
                <label><strong>Course:</strong></label>
                <select onchange="updateCourseDetails(this, '${collegeId}', '${category}')">
                    ${courseOptions}
                </select>
                <div id="course-${collegeId}">${renderCourseDetails(defaultCourse)}</div>
            </div>

            <div class="section-header">💼 Placement</div>
            <div class="section-card">
                <p>
                    <strong>Avg Package:</strong> ₹${formatINR(place ? place.avg_ctc : undefined) || '-'}<br>
                    <strong>Highest:</strong> ₹${formatINR(place ? place.highest_ctc : undefined) || '-'}<br>
                    <strong>Placement %:</strong> ${place && typeof place.placement_percentage === 'number' ? (place.placement_percentage * 100).toFixed(2) + '%' : '-'}
                </p>
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                    <button class="action-button" onclick="toggleCompaniesVisited('${collegeId}')">Companies Visited</button>
                    <button class="action-button" onclick="handleBrochure('${collegeId}')">Brochure</button>
                </div>
                <div id="companies-${collegeId}" class="companies-section" style="display: none; margin-top: 15px;">
                    <div class="section-header">🏢 Companies Visiting Campus</div>
                    <div class="section-card" id="companies-content-${collegeId}">
                        <p>Loading companies data...</p>
                    </div>
                </div>
            </div>
        `;
        comparisonSection.appendChild(box);
    });
}
function renderCourseComparison() {
    courseComparisonSection.innerHTML = ""; // Clear previous comparison boxes

    selectedCourseColleges.forEach(({ collegeId, courseId }) => {
        // Find the college details from collegesData
        const col = collegesData.find(c => c.college_id === collegeId);
        // Find placement data if available
        const place = placementsData.find(p => p.college_id === collegeId);

        // Get all courses for this specific college
        const allCourses = coursesData.filter(c => c.college_id === collegeId);

        // Determine the default course to display initially
        // This should be the course that was initially selected to get into this comparison
        let defaultCourse = allCourses.find(c => c.course_id === courseId);
        if (!defaultCourse && allCourses.length > 0) {
            defaultCourse = allCourses[0]; // Fallback to the first course if the specific ID isn't found (should be rare)
        } else if (!defaultCourse) {
            defaultCourse = null; // Ensure it's null if no courses are found
        }


        let courseOptions = "";
        if (defaultCourse) { // Only generate options if there's a default course (and thus related courses)
            // Filter courses to only include those with the same course_name as the default (for specialization dropdown)
            const filteredCoursesForOptions = allCourses.filter(c => c.course_name === defaultCourse.course_name);

            // Create a unique list of specializations for the dropdown
            const seenSpecs = new Set();
            const uniqueSpecializationCourses = [];
            filteredCoursesForOptions.forEach(c => {
                const spec = c.specialisation || 'General';
                if (!seenSpecs.has(spec)) {
                    seenSpecs.add(spec);
                    uniqueSpecializationCourses.push(c); // Push the whole course object to retain course_id
                }
            });

            // Ensure the initially selected defaultCourse is the first option if it's a part of unique specializations
            // Or simply build options based on unique specializations
            const sortedSpecializationCourses = [
                defaultCourse, // Prioritize the defaultCourse
                ...uniqueSpecializationCourses.filter(c => c.course_id !== defaultCourse.course_id)
                    .sort((a, b) => (a.specialisation || '').localeCompare(b.specialisation || ''))
            ];

            courseOptions = sortedSpecializationCourses.map(c =>
                `<option value="${c.course_id}" ${c.course_id === defaultCourse.course_id ? 'selected' : ''}>${c.specialisation || 'General'}</option>`
            ).join("");
        }


        // Create the comparison box element
        const box = document.createElement("div");
        box.className = "comparison-box";

        // Populate the inner HTML of the comparison box
        box.innerHTML = `
            <button class="comparison-close-btn" onclick="removeCourseCollegeFromComparison('${collegeId}')" title="Remove from comparison">×</button>
            <h4 class="college-title">${col ? col.college_name : 'College Not Found'}</h4>

            <div class="section-header">📘 Basic Information</div>
            <div class="section-card">
                <p>
                    <strong>Established:</strong> ${col ? col.established_year || '-' : '-'}<br>
                    <br>
                    <strong>Ranking/USP:</strong> ${col.Ranking_or_USP || '-'}<br>
                    <br>
                    <strong>Website:</strong> ${col && col.website ? `<a href="${col.website}" target="_blank">${col.website}</a>` : '-'}<br>
                    <br>
                    <strong>Application Form Fees:</strong> ₹${formatINR(col ? col.application_form_fees : undefined) || 'N/A'}<br>
                    <br>
                    <strong>Coupon Link:</strong> ${col.coupon_code_link ? `<a href="${col.coupon_code_link}" target="_blank" style="color: #007bff; text-decoration: underline;">View/Apply Coupon</a>` : 'N/A'}<br>
                    <br>
                    <strong>Seat Block Fees:</strong> ₹${formatINR(col ? col.seat_block_fees : undefined) || 'N/A'}
                </p>
            </div>

            <div class="section-header">🎓 Course Details</div>
            <div class="section-card">
                <label><strong>Specialization:</strong></label>
                <select onchange="updateCourseDetailsForCompare(this, '${collegeId}')">
                    ${courseOptions}
                </select>
                <div id="compare-course-${collegeId}">${renderCourseDetails(defaultCourse)}</div>
            </div>

            <div class="section-header">💼 Placement</div>
            <div class="section-card">
                <p>
                    <strong>Avg Package:</strong> ₹${formatINR(place ? place.avg_ctc : undefined) || '-'}<br>
                    <strong>Highest:</strong> ₹${formatINR(place ? place.highest_ctc : undefined) || '-'}<br>
                    <strong>Placement %:</strong> ${place && typeof place.placement_percentage === 'number' ? (place.placement_percentage * 100).toFixed(2) + '%' : '-'}
                </p>
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                    <button class="action-button" onclick="toggleCompaniesVisited('${collegeId}')">Companies Visited</button>
                    <button class="action-button" onclick="handleBrochure('${collegeId}')">Brochure</button>
                </div>
                <div id="companies-${collegeId}" class="companies-section" style="display: none; margin-top: 15px;">
                    <div class="section-header">🏢 Companies Visiting Campus</div>
                    <div class="section-card" id="companies-content-${collegeId}">
                        <p>Loading companies data...</p>
                    </div>
                </div>
            </div>
        `;
        courseComparisonSection.appendChild(box);
    });
}

// ✨ Function to Add College to Comparison (College Search Mode)
window.selectCollege = function(collegeId, category) {
  if (selectedColleges.length >= 4) selectedColleges.shift();
  selectedColleges.push({ collegeId, category });
  renderComparison();
};


// ✨ Function to Add College to Comparison (Course Search Mode)
window.selectCourseCollege = function(collegeId, courseId) {
  if (selectedCourseColleges.length >= 4) selectedCourseColleges.shift(); // allow max 4
  selectedCourseColleges.push({ collegeId, courseId });
  renderCourseComparison(); // re-render course comparison
};

// ❌ Function to Remove College from Comparison (College Search Mode)
window.removeCollegeFromComparison = function(collegeId) {
  selectedColleges = selectedColleges.filter(item => item.collegeId !== collegeId);
  renderComparison(); // re-render comparison
};

// ❌ Function to Remove College from Comparison (Course Search Mode)
window.removeCourseCollegeFromComparison = function(collegeId) {
  selectedCourseColleges = selectedCourseColleges.filter(item => item.collegeId !== collegeId);
  renderCourseComparison(); // re-render course comparison
};

// 🎯 LANDING PAGE SELECTOR (Switch between College and Course Search)
window.selectMode = function(mode) {
  const selector = document.getElementById('initialSelector');
  selector.style.opacity = 0;
  setTimeout(() => {
    selector.style.display = 'none';
    if (mode === 'college') {
      document.getElementById('dashboardContent').style.display = 'block';
      document.getElementById('courseSearchContent').style.display = 'none';
    } else if (mode === 'course') {
      document.getElementById('dashboardContent').style.display = 'none';
      document.getElementById('courseSearchContent').style.display = 'block';
    }
  }, 600);
};

// 🚀 EVENT LISTENERS (for Filters, Search, Buttons)
document.addEventListener("DOMContentLoaded", () => {
  console.log('🌟 DOM Content Loaded - Starting data loading...');
  loadAllData();
});
document.getElementById("modeToggleBtn").addEventListener("click", () => {
  const isCollegeVisible = document.getElementById("dashboardContent").style.display !== "none";

  if (isCollegeVisible) {
    // Switch to course search
    document.getElementById("dashboardContent").style.display = "none";
    document.getElementById("courseSearchContent").style.display = "block";
    document.getElementById("modeToggleBtn").textContent = "Switch to College Search";
  } else {
    // Switch to college search
    document.getElementById("dashboardContent").style.display = "block";
    document.getElementById("courseSearchContent").style.display = "none";
    document.getElementById("modeToggleBtn").textContent = "Switch to Course Search";
  }
});

// 🎯 College Search (Dashboard Filters)
stateSelect.addEventListener("change", () => {
  categorySelect.disabled = false;
  populateCategories();
  promptMessage.style.display = "block";
  document.getElementById('feesFilter').classList.add('disabled');
  updateCollegeList();
});

categorySelect.addEventListener("change", () => {
  promptMessage.style.display = "none";
  document.getElementById('feesFilter').classList.remove('disabled');
  updateCollegeList();
});

searchBox.addEventListener("input", debouncedUpdateCollegeList); // 🚀 Debounced search for smooth typing
resetBtn.addEventListener("click", resetFilters);
btechOnlyCheckbox.addEventListener("change", updateCollegeList);

// 💰 College Search Fees Slider Events with Debouncing
feesSlider.addEventListener("input", () => {
  syncSliderAndInput(feesSlider, feesInput, feesDisplay);
  debouncedUpdateCollegeList(); // 🚀 Debounced for smooth performance
});

// 🔥 REAL-TIME Manual Input with Debouncing
feesInput.addEventListener("input", () => {
  const value = parseInt(feesInput.value);
  if (!isNaN(value)) {
    feesDisplay.textContent = formatFeesDisplay(value);
    // 🚀 Real-time update with debouncing - no need to click elsewhere!
    setTimeout(() => {
      syncInputAndSlider(feesInput, feesSlider, feesDisplay);
      debouncedUpdateCollegeList();
    }, 50);
  }
});

// Keep blur and keydown for immediate response when user finishes
feesInput.addEventListener("blur", () => {
  syncInputAndSlider(feesInput, feesSlider, feesDisplay);
  updateCollegeList(); // Immediate update on blur
});
feesInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    syncInputAndSlider(feesInput, feesSlider, feesDisplay);
    updateCollegeList(); // Immediate update on Enter
    feesInput.blur();
  }
});

// 🎯 Course Search (Filters)
stateDropdown.addEventListener("change", updateCourseCollegeList);

// 💰 Course Search Fees Slider Events with Debouncing
feesSliderCourse.addEventListener("input", () => {
  syncSliderAndInput(feesSliderCourse, feesInputCourse, feesDisplayCourse);
  debouncedUpdateCourseCollegeList(); // 🚀 Debounced for smooth performance
});

// 🔥 REAL-TIME Manual Input with Debouncing
feesInputCourse.addEventListener("input", () => {
  const value = parseInt(feesInputCourse.value);
  if (!isNaN(value)) {
    feesDisplayCourse.textContent = formatFeesDisplay(value);
    // 🚀 Real-time update with debouncing - no need to click elsewhere!
    setTimeout(() => {
      syncInputAndSlider(feesInputCourse, feesSliderCourse, feesDisplayCourse);
      debouncedUpdateCourseCollegeList();
    }, 50);
  }
});

// Keep blur and keydown for immediate response when user finishes
feesInputCourse.addEventListener("blur", () => {
  syncInputAndSlider(feesInputCourse, feesSliderCourse, feesDisplayCourse);
  updateCourseCollegeList(); // Immediate update on blur
});
feesInputCourse.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    syncInputAndSlider(feesInputCourse, feesSliderCourse, feesDisplayCourse);
    updateCourseCollegeList(); // Immediate update on Enter
    feesInputCourse.blur();
  }
});


// Utility to clear course comparison
function clearCourseComparison() {
    selectedCourseColleges = [];
    courseComparisonSection.innerHTML = "";
}

courseInput.addEventListener("change", function() {
    clearCourseComparison();
    // Get the currently selected course name
    const selectedCourse = this.value;
    if (selectedCourse) {
        loadSpecializations(selectedCourse);
        stateDropdown.disabled = false;
        feesDropdown.classList.remove('disabled');
        updateCourseCollegeList();
    } else {
        specializationDropdown.innerHTML = '<option value="">Select Specialization</option>';
        specializationDropdown.style.display = 'none';
        specializationDropdown.disabled = true;
        stateDropdown.disabled = false;
        feesDropdown.classList.remove('disabled');
        courseCollegeList.innerHTML = "";
        clearCourseComparison();
    }
});

// Add clearCourseComparison to all relevant filter events in course search mode
stateDropdown.addEventListener("change", function() {
    clearCourseComparison();
    updateCourseCollegeList();
});

feesSliderCourse.addEventListener("input", () => {
    clearCourseComparison();
    syncSliderAndInput(feesSliderCourse, feesInputCourse, feesDisplayCourse);
    debouncedUpdateCourseCollegeList();
});

feesInputCourse.addEventListener("input", () => {
    clearCourseComparison();
    const value = parseInt(feesInputCourse.value);
    if (!isNaN(value)) {
        feesDisplayCourse.textContent = formatFeesDisplay(value);
        setTimeout(() => {
            syncInputAndSlider(feesInputCourse, feesSliderCourse, feesDisplayCourse);
            debouncedUpdateCourseCollegeList();
        }, 50);
    }
});

// For specialization checkboxes, update the event in loadSpecializations
// (Replace the previous event listener line with this:)
// checkbox.addEventListener('change', function() { clearCourseComparison(); debouncedUpdateCourseCollegeList(); });

document.getElementById('courseResetBtn').addEventListener('click', resetCourseFilters);



// 🌟 OPEN MODAL FUNCTION
window.openInterestModal = function(collegeName = "", courseName = "") {
  const container = document.getElementById('collegeCourseContainer');
  container.innerHTML = ''; // Clear previous groups
  addCollegeCourseGroup(collegeName, courseName); // Add 1 pre-filled group

  document.getElementById('interestForm').reset(); // Clear form fields
  document.getElementById('interestModal').style.display = 'flex';
};

// 📥 ADD COURSE + COLLEGE SELECT GROUP
function addCollegeCourseGroup(preselectedCollege = "", preselectedCourse = "") {
  const container = document.getElementById('collegeCourseContainer');

  const group = document.createElement('div');
  group.className = 'college-course-group';
  group.style.display = 'flex';
  group.style.flexWrap = 'wrap';
  group.style.gap = '10px';
  group.style.marginBottom = '10px';

  const collegeSelect = document.createElement('input');
  collegeSelect.type = 'text';
  collegeSelect.list = 'modalCollegeSuggestions';
  collegeSelect.placeholder = 'Select or type college name...';
  collegeSelect.style.flex = '1 1 48%';
  collegeSelect.style.padding = '10px';
  collegeSelect.style.fontSize = '14px';
  collegeSelect.style.borderRadius = '6px';
  collegeSelect.style.border = '1px solid #ccc';
  collegeSelect.style.fontFamily = 'Poppins, sans-serif';
  collegeSelect.required = true;

  const courseSelect = document.createElement('select');
  courseSelect.innerHTML = '<option value="">Select Course</option>';
  courseSelect.style.flex = '1 1 48%';
  courseSelect.required = true;

  collegeSelect.addEventListener('input', function () {
    const selectedCollege = this.value;
    courseSelect.innerHTML = '<option value="">Select Course</option>';

    const selectedCollegeObj = collegesData.find(c => c.college_name === selectedCollege);
    if (selectedCollegeObj) {
      const filteredCourses = coursesData.filter(c => c.college_id === selectedCollegeObj.college_id);
      const uniqueCourses = [...new Set(filteredCourses.map(c => c.course_name))].sort();

      uniqueCourses.forEach(courseName => {
        const opt = document.createElement('option');
        opt.value = courseName;
        opt.textContent = courseName;
        courseSelect.appendChild(opt);
      });

      if (uniqueCourses.length > 0 && !preselectedCourse) {
        courseSelect.value = uniqueCourses[0];
      }
    }
  });

  // Prefill if given
  if (preselectedCollege) {
    collegeSelect.value = preselectedCollege;
    collegeSelect.dispatchEvent(new Event('change'));
    setTimeout(() => {
      if (preselectedCourse) {
        courseSelect.value = preselectedCourse;
      }
    }, 100);
  }

  group.appendChild(collegeSelect);
  group.appendChild(courseSelect);
  container.appendChild(group);
}

window.closeModal = function () {
  document.getElementById('interestModal').style.display = 'none';
};


// 🛠️ Utility to Load Specializations for Selected Course
// 🛠️ Utility to Load Specializations for Selected Course (Now with Checkboxes)
function loadSpecializations(courseName) {
    const checkboxContainer = document.getElementById('specializationCheckboxes');
    const mainContainer = document.getElementById('specializationContainer'); // The outer container div

    checkboxContainer.innerHTML = ''; // Clear previous checkboxes

    const specs = [...new Set(coursesData
        .filter(c => c.course_name === courseName)
        .map(c => c.specialisation)
        .filter(s => s && s.trim() !== '') // Filter out empty/null specializations
    )].sort();

    if (specs.length > 0) {
        specs.forEach(spec => {
            const checkboxId = `spec-${spec.replace(/\s+/g, '-')}`; // Create a unique ID

            const wrapper = document.createElement('div'); // Wrapper for checkbox + label
            wrapper.style.marginBottom = '5px';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = checkboxId;
            checkbox.value = spec;
            checkbox.className = 'specialization-checkbox'; // Add a class for potential styling/selection
            // Add event listener to update list when checkbox changes
            checkbox.addEventListener('change', function() { clearCourseComparison(); debouncedUpdateCourseCollegeList(); }); // 🚀 Debounced for smooth checkbox interaction

            const label = document.createElement('label');
            label.htmlFor = checkboxId;
            label.textContent = spec;
            label.style.marginLeft = '5px';

            wrapper.appendChild(checkbox);
            wrapper.appendChild(label);
            checkboxContainer.appendChild(wrapper);
        });
        mainContainer.style.display = 'block'; // Show the container
    } else {
        // No specializations found for this course
        checkboxContainer.innerHTML = '<p style="font-style: italic; font-size: 0.9em;">No specific specializations found.</p>';
        mainContainer.style.display = 'block'; // Still show container, but with the message
    }

    // We might not need the separate specializationDropdown.disabled state anymore
    // The container's display style handles visibility.
}

// 🧹 RESET FILTER FUNCTIONS
function resetFilters() {
  stateSelect.value = "";
  categorySelect.innerHTML = '<option value="">Select Category</option>';
  categorySelect.disabled = true;
  
  // Reset fees slider to maximum checkpoint value
  feesSlider.value = "2000000";
  feesInput.value = "2000000";
  feesDisplay.textContent = formatFeesDisplay(2000000);
  document.getElementById('feesFilter').classList.add('disabled');
  
  searchBox.value = "";
  btechOnlyCheckbox.checked = false;
  collegeList.innerHTML = "";
  comparisonSection.innerHTML = "";
  promptMessage.style.display = "none";
  selectedColleges = [];
}
// 🧹 RESET FILTER FUNCTIONS

function resetCourseFilters() {
    // Reset main course dropdown
    if (courseInput) {
        courseInput.value = "";
    }

    // --- NEW: Reset Specialization Checkboxes Area ---
    // Use the ID you confirmed exists in your HTML: 'specializationContainer'
    const specializationContainer = document.getElementById('specializationContainer');
    // Use the ID for the div holding the actual checkboxes
    const checkboxContainer = document.getElementById('specializationCheckboxes');

    // Hide the main container for checkboxes
    if (specializationContainer) {
        specializationContainer.style.display = 'none'; // Hides the whole checkbox section
    }

    // Clear any existing checkboxes
    if (checkboxContainer) {
        checkboxContainer.innerHTML = ''; // Clear out the old checkboxes/message
    }
    // --- End NEW ---

    // Reset State dropdown
    if (stateDropdown) { // Added safety check
        stateDropdown.value = "";
        stateDropdown.disabled = false; // Ensure it's usable
    }

    // Reset Fees slider to maximum checkpoint value
    if (feesSliderCourse && feesInputCourse && feesDisplayCourse) {
        feesSliderCourse.value = "2000000";
        feesInputCourse.value = "2000000";
        feesDisplayCourse.textContent = formatFeesDisplay(2000000);
        feesDropdown.classList.remove('disabled'); // Ensure it's usable
    }

    // Clear the results lists
    if (courseCollegeList) {
        courseCollegeList.innerHTML = "";
    }
    if (courseComparisonSection) { // Make sure comparison is cleared
        courseComparisonSection.innerHTML = "";
    }

    // Reset the selected colleges array for comparison
    selectedCourseColleges = [];
}

// 🖱️ BUTTON HANDLERS (Brochure)
function handleBrochure(collegeId) {
  const college = collegesData.find(c => c.college_id === collegeId);

  if (college && college.brochure) {
    window.open(college.brochure, "_blank");
  } else {
    alert("📁 No brochure link available for this college.");
  }
}

// 🏢 BUTTON HANDLERS (Companies Visited)
function toggleCompaniesVisited(collegeId) {
  const companiesSection = document.getElementById(`companies-${collegeId}`);
  const companiesContent = document.getElementById(`companies-content-${collegeId}`);
  
  if (!companiesSection || !companiesContent) {
    console.error('Companies section elements not found for college:', collegeId);
    return;
  }

  // Toggle visibility
  const isVisible = companiesSection.style.display !== 'none';
  
  if (isVisible) {
    // Hide the section
    companiesSection.style.display = 'none';
  } else {
    // Show the section and load companies data
    companiesSection.style.display = 'block';
    loadCompaniesData(collegeId, companiesContent);
  }
}

function loadCompaniesData(collegeId, contentElement) {
  console.log('🔍 Loading companies data for college ID:', collegeId);
  
  const college = collegesData.find(c => c.college_id === collegeId);
  console.log('🏫 Found college:', college);
  console.log('🔍 All college properties:', Object.keys(college));
  
  if (!college) {
    contentElement.innerHTML = '<p class="no-companies-message">College data not found.</p>';
    return;
  }

  console.log('📋 College companies field:', college.companies_visiting_campus);
  const companiesData = college.companies_visiting_campus;
  
  if (!companiesData || companiesData.trim() === '') {
    console.log('❌ No companies data found');
    contentElement.innerHTML = '<p class="no-companies-message">No companies data available for this college.</p>';
    return;
  }

  // Split companies by comma and clean up
  const companies = companiesData.split(',')
    .map(company => company.trim())
    .filter(company => company.length > 0);

  if (companies.length === 0) {
    contentElement.innerHTML = '<p class="no-companies-message">No companies data available for this college.</p>';
    return;
  }

  // Create company tags
  const companiesHTML = companies.map(company => 
    `<span class="company-tag">${company}</span>`
  ).join('');

  contentElement.innerHTML = `
    <div class="companies-list">
      ${companiesHTML}
    </div>
  `;
}
document.getElementById('interestForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const studentName = document.getElementById('studentName').value.trim();
  const studentPhone = document.getElementById('studentPhone').value.trim();
  const studentEmail = document.getElementById('studentEmail').value.trim();
  const counselor = document.getElementById('counselorSelect').value.trim();

  if (!studentName || !studentPhone || !studentEmail || !counselor) {
    alert("⚠️ Please fill all student details.");
    return;
  }

  const groups = document.querySelectorAll('.college-course-group');
  const submissions = [];

  groups.forEach(group => {
    const college = group.querySelector('select:nth-child(1)').value;
    const course = group.querySelector('select:nth-child(2)').value;
    if (college && course) {
      submissions.push({ college, course });
    }
  });

  if (submissions.length === 0) {
    alert("⚠️ Please select valid colleges and courses.");
    return;
  }

  try {
    await Promise.all(submissions.map(data => {
      const payload = {
        college: data.college,
        course: data.course,
        student_name: studentName,
        phone: studentPhone,
        email: studentEmail,
        counselor: counselor
      };
      return fetch('https://sheetdb.io/api/v1/usp9neaj4ni3v', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    }));

    alert("✅ All leads submitted successfully!");
    closeModal();
  } catch (error) {
    console.error(error);
    alert("❌ Error submitting leads. Please try again.");
  }
});

document.addEventListener("DOMContentLoaded", () => {
  // ✅ When the page is fully loaded, then attach the button functionality

  const addMoreBtn = document.getElementById('addMoreBtn');
  if (addMoreBtn) {
    addMoreBtn.addEventListener('click', () => addCollegeCourseGroup());
  }
  stateDropdown.disabled = false;
  feesDropdown.classList.remove('disabled');
  // Note: Data loading is now handled by loadAllData() function
});

    </script>
    
  
</body>
</html>
